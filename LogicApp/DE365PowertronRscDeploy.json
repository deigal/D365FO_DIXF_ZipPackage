{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        //0. Parameters for all resources
        "location": {
                "type":"string",
                "defaultValue": "[resourceGroup().location]"
            },
        //1. Parameters of azure storage
        "storagePrefix": {
            "type": "string",
            "defaultvalue": "dixfstorage",
            "minLength": 3,
            "maxLength": 24
        },
        
        "storageSku": {
                "type": "string",
                "defaultValue": "Standard_LRS",
                "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS",
                "Premium_ZRS",
                "Standard_GZRS",
                "Standard_RAGZRS"
                ]
            },

        "AzureBlobContainerId": {
            "type": "string",
            "defaultValue":"dmfcreatepackage",
            "minLength": 3,
            "maxLength": 24
        },
        //2. Parameters of logic app
        "LogicAppPrefix":
        {
            "type": "string",
            "defaultvalue": "dixfLogicApp",
            "minLength": 3,
            "maxLength": 24
        },

        "DefaultFileExtension": {
            "defaultValue": ".csv",
            "type": "String"
        },
        
        "FileContentType": {
            "defaultValue": "text/csv",
            "type": "String"
        },

        "PriceJournalIdPlaceholder": {
            "defaultValue": "PRICEEVENT",
            "type": "String"
        },

        "OneDriveFolder": {
            "type": "String",
            "defaultValue": "/Projects/00 - In progress/978 - Staples/PIM_RTL/Preise/PRICE_INPUT"
        },

        //3. Parameters of Dynamics 365FO
       "D365FOCompanyId": {
            "defaultValue": "DEMF",
            "type": "String"
        },
        
        "D365FODefaultPriceJournalName": {
            "defaultValue": "VK-Preise",
            "type": "String"
        },
       
        //4. Connections
        //4.1 Azure Blob
        "connections_azureblob_prefix": {
            "defaultValue": "azureblob",
            "type": "String"
        },
        "connections_azureblob_displayname": {
            "defaultValue": "Azure Blob Storeage",
            "type": "String"
        },
        "connections_azureblob_api": {
            "defaultValue": "azureblob",
            "type": "String"
        },
        //4.2 Dynamics AX
        "connections_dynamicsax_prefix": {
            "defaultValue": "dynamicsax",
            "type": "String"
        },
        "connections_dynamicsax_displayname": {
            "defaultValue": "Dynamics 365 FO",
            "type": "String"
        },
        "connections_dynamicsax_api": {
            "defaultValue": "dynamicsax",
            "type": "String"
        },
        //4.3 One Drive
        "connections_onedriveforbusiness_externalid": {
            "defaultValue": "",
            "type": "String"
        }
    },
    
    "variables": {
        "uniquedeploymenthash": "[uniqueString(resourceGroup().id)]",
        "uniqueStorageName": "[concat(parameters('storagePrefix'), variables('uniquedeploymenthash'))]",
        "uniqueLogicAppName": "[concat(parameters('LogicAppPrefix'), variables('uniquedeploymenthash'))]",
        "uniqueDAXConnectionName": "[concat(parameters('connections_dynamicsax_prefix'), variables('uniquedeploymenthash'))]",
        "uniqueAzureBlobConnectionName": "[concat(parameters('connections_azureblob_prefix'), variables('uniquedeploymenthash'))]"
    },
    "resources": [
        //0. Connections
        //0.1 Dynamics AX
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('uniqueDAXConnectionName')]",
            "location": "[parameters('location')]",
            "properties": {
                "displayName": "[parameters('connections_dynamicsax_displayname')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location,'/managedApis/', parameters('connections_dynamicsax_api'))]"
                }
            }
        },
        //Deploy Azure Storage Account
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-04-01",
            "name": "[variables('uniqueStorageName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name":"[parameters('storageSku')]"
            },
            "kind": "StorageV2",
            "properties": {
                "supportsHttpsTrafficOnly": true
            },
            "resources": [
                {
                "type": "blobServices/containers",
                "apiVersion": "2019-06-01",
                "name": "[concat('default/', parameters('AzureBlobContainerId'))]",
                "dependsOn": [
                    "[variables('uniqueStorageName')]"
                ]
                }
            ]
        },
        //3. Deploy Connection to Azure Storeage Account
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('uniqueAzureBlobConnectionName')]",
            "location": "[parameters('location')]",
            "properties": {
                "displayName": "[parameters('connections_azureblob_displayname')]",
                "parameterValues": {
                   "accountName": "[variables('uniqueStorageName')]",
                    "accessKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts',variables('uniqueStorageName')), '2019-06-01').keys[0].value]"                                                                        
                    },          
                "api": {
                    "id": "[concat('subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location,'/managedApis/', parameters('connections_azureblob_api'))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts',variables('uniqueStorageName'))]"
            ]
        }
        /*,
        {
           "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[variables('uniqueLogicAppName')]",
            "location": "[parameters('location')]",
            "properties": {
                "state": "Disabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"#
                        }
                    },

                    "triggers": {
                        "When_a_file_is_created": {
                            "recurrence": {
                                "frequency": "Minute",
                                "interval": 1
                            },
                            "metadata": {
                                "b!VA67345UL02OyI5wGvY1xJbe8XKndHdOuih5MtZy11yynz4OuelaRr2xWV6g7eDi.01NKZMXPY6O6W2GGKKZZFJ23FMJXUAGCFM": "/Projects/00 - In progress/978 - Staples/PIM_RTL/Preise/PRICE_INPUT"
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['onedriveforbusiness']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/datasets/default/triggers/onnewfilev2",
                                "queries": {
                                    "folderId": "b!VA67345UL02OyI5wGvY1xJbe8XKndHdOuih5MtZy11yynz4OuelaRr2xWV6g7eDi.01NKZMXPY6O6W2GGKKZZFJ23FMJXUAGCFM",
                                    "includeSubfolders": false,
                                    "inferContentType": true,
                                    "simulate": false
                                }
                            }
                        }
                    }
                }
            
            }
        }
        */
    ]
}